<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout | DriveX</title>
  <style>
    :root { --accent: #ff5f00; --bg: #111; --card-bg: #1c1c1c; --input-bg: #252525; }
    body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; margin: 0; }
    header { background: #000; padding: 20px 8%; font-weight: 900; font-size: 24px; }
    header span { color: var(--accent); }
    main { padding: 40px 8%; max-width: 1400px; margin: auto; display: grid; grid-template-columns: 1.8fr 1fr; gap: 40px; }
    .checkout-form { background: var(--card-bg); padding: 40px; border-radius: 16px; }
    .checkout-form h1 { margin-top:0; font-size: 36px; margin-bottom: 30px; font-weight: 800; }
    .checkout-form h2 { margin-bottom: 25px; font-size: 20px; font-weight: 700; }
    .name-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    input[type="text"], input[type="email"], input[type="tel"] {
      width: 100%; background: var(--input-bg); border: 1px solid #333; border-radius: 10px;
      padding: 16px 20px; color: #fff; font-size: 16px; transition: all 0.3s;
    }
    input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 12px rgba(255,95,0,0.2); }
    label { display: flex; align-items: center; gap: 10px; cursor: pointer; color: #aaa; margin-top: 15px; }
    .rent-btn {
      margin-top: 30px; width: 100%; background: var(--accent); color: #fff; border: none;
      padding: 18px; border-radius: 10px; font-weight: 800; text-transform: uppercase; cursor: pointer; transition: 0.3s;
    }
    .rent-btn:hover { background: #e55500; transform: translateY(-2px); }
    .summary-card { background: var(--card-bg); padding: 30px; border-radius: 16px; border-left: 5px solid var(--accent); position: sticky; top: 40px; }
    .summary-card img { width: 100%; object-fit: contain; border-radius: 12px; margin-bottom: 20px; }
    .summary-card h3 { margin: 0; font-size: 24px; }
    .summary-card p { margin: 5px 0; color: #ccc; }
    .summary-card hr { border: 0; border-top: 1px solid #333; margin: 20px 0; }
    .summary-total { font-size: 22px; font-weight: 900; color: var(--accent); margin-top: 20px; }
    .summary-loc span { display: block; color: #ccc; margin-bottom: 10px; }
    .summary-included { background: #252525; padding: 12px; border-radius: 8px; font-size: 13px; color: #888; margin-top: 15px; }
  </style>
</head>
<body>

<header>DRIVE<span>X</span></header>

<main>
  <section class="checkout-form">
    <h1>Review your booking</h1>
    <h2>Who will drive?</h2>
    <div class="name-grid">
      <input type="text" id="firstName" placeholder="First Name">
      <input type="text" id="lastName" placeholder="Last Name">
    </div>
    <input type="email" id="email" placeholder="Email Address" style="margin-bottom:20px;">
    <input type="tel" id="phone" placeholder="Phone Number" style="margin-bottom:20px;">
    <input type="text" id="license" placeholder="Driver's License Number" style="margin-bottom:20px;">
    <label>
      <input type="checkbox" id="ageCheck"> I am 25 years or older
    </label>
    <button class="rent-btn" onclick="submitToDatabase()">Confirm & Save Booking</button>
  </section>

  <aside>
    <div class="summary-card">
      <img id="summaryImage" src="" alt="Vehicle">
      <h3 id="summaryModel">Loading...</h3>
      <p id="summaryCity">City</p>
      <hr>
      <div class="summary-loc">
        <strong>üìç Pickup Location:</strong>
        <span id="pickupLoc">City</span>
        <strong>üèÅ Return Location:</strong>
        <span id="returnLoc">City</span>
      </div>
      <div class="summary-total" id="summaryTotal">$0.00</div>
      <div class="summary-included">Included: Free Cancellation, Unlimited Kilometers.</div>
    </div>
  </aside>
</main>

<script>
  const bookingData = JSON.parse(localStorage.getItem('bookingData') || '{}');
  
  window.onload = function() {
    const bookingData = JSON.parse(localStorage.getItem('bookingData') || '{}');
    
    if (bookingData.model) {
        document.getElementById('summaryImage').src = bookingData.image;
        document.getElementById('summaryModel').innerText = bookingData.model;
        
        const finalCity = bookingData.city || localStorage.getItem("selectedCity") || "Not specified";
        
        document.getElementById('summaryCity').innerText = finalCity;
        document.getElementById('pickupLoc').innerText = finalCity;
        document.getElementById('returnLoc').innerText = finalCity;
        
        document.getElementById('summaryTotal').innerText = bookingData.total;
    }
};

  async function submitToDatabase() {
    const fName = document.getElementById('firstName').value.trim();
    const lName = document.getElementById('lastName').value.trim();
    
    if (!fName || !lName) {
      alert("Please fill in Name");
      return;
    }

    const priceText = document.getElementById('summaryTotal').innerText;
    const numericPrice = parseFloat(priceText.replace(/[^0-9.]/g, '')) || 0;

    const payload = {
      fullName: fName + " " + lName,
      email: document.getElementById('email').value,
      phone: document.getElementById('phone').value,
      licenseNumber: document.getElementById('license').value,
      vehicleId: bookingData.id ? parseInt(bookingData.id) : 1, 
      startDatetime: new Date().toISOString().slice(0, 19), 
      endDatetime: new Date(Date.now() + 86400000).toISOString().slice(0, 19),
      totalPrice: numericPrice
    };

    try {
      const response = await fetch('http://localhost:8080/api/checkout/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        const result = await response.text();
        const bookingId = result.split(': ')[1] || '1';
        window.location.href = `success.html?id=${bookingId}`;
      } else {
        alert("Error saving data.");
      }
    } catch (e) {
      alert("Connection failed.");
    }
  }
</script>
</body>
</html>